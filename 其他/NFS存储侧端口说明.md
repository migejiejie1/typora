```shell
【技术分享】NFS存储侧端口说明

NFS存储侧端口说明

针对NFSv3协议其文件系统和锁是独立实现的，在使用过程中存储侧会固定使用TCP或者UDP的2049、2050、2051、2052和111端口，其中各端口使用说明如下：

1、NFS协议基于RPC协议进行通信，因此在使用过程中会使用PortMap协议。主机访问时，先通过PortMap协议（主机任意TCP/UDP端口->存储的111端口）向存储查询相关的端口信息，包括：挂载的监听端口（2050）、业务监听端口（2049）、加锁监听端口（2052）和管理锁监听端口（2051）；

2、主机通过NFSv3协议挂载V3存储的NFS共享时，主机使用TCP/UDP任意端口和存储的业务IP的2050端口进行通信，存储正常响应。

3、主机读写文件时，主机使用TCP/UDP任意端口和存储的业务IP的2049端口进行通信，存储正常响应；

4、主机向存储加锁时，主机向存储业务IP的2052端口请求。分为同步锁和异步锁两种场景：

若是同步锁请求，存储直接向主机返回加锁结果；

若是异步锁请求，其处理流程如下：

    ①存储直接响应主机一个临时响应，让其等待；

    ②待存储加锁成功后，存储会通过PortMap协议（存储的任意TCP/UDP端口->主机的111端口）向主机发起请求获取主机用于接收加锁结果的端口；

    ③存储获取到主机加锁使用的端口后，会新建TCP/UDP链接（存储的任意TCP/UDP端口->主机的加锁端口），通知主机加锁结果；

   ④主机获取到加锁结果后，链接会断开，该端口会释放。

因此针对异步锁，存储会使用到1~65535端口；


5、2051端口是存储用于管理NFSv3锁的状态，如主机发生重启时，用于通知存储进行锁清理等；

综上，基于NFSv3协议建议防火墙策略放行存储业务IP。

华为存储
```

